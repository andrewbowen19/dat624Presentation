---
title: 'DATA 624 Presentation: Time Series Decomposition'
author: "Andrew Bowen"
date: "2024-02-04"
output: 
  ioslides_presentation:
    smaller: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(tsibble)
library(feasts)
```


## Our Dataset
- We pulled [data representing Citibike rides in Jersey City during Q4 of 2023](https://s3.amazonaws.com/tripdata/index.html)

```{r data-read-in, warning=FALSE, message=FALSE}
# Read in our dataset and store it as a `tsibble` obejct
df <- read_csv("data/rides_per_hour.csv")
rides <- df %>% as_tsibble(index=start_time, key=c(start_station_name, rideable_type, member_casual))

# Fill NAs with 0s
rides <- fill_gaps(rides, number_of_rides=0)
head(rides)
```


## Viewing our Data
It's always a good idea to plot your time series prior to any sort of decomposition
```{r plot-top-stations, echo=FALSE}
# Select out top station
top_stations <- rides %>% 
  group_by(start_station_name) %>% 
  summarise(number_of_rides = sum(number_of_rides)) %>% 
  filter(start_station_name == "Columbus Drive")

# Plot 
autoplot(top_stations, number_of_rides) + 
  labs(x="Start Time",
       y="Number of Rides",
       title="Columbus Drive (Jersey City) Citi Bike Rides: Fall 2024")
```


## Plotting Seasonality
Below is the seasonal plot of our data for a daily period. We see a higher number of rides around 5-6pm, when many people are commuting.
```{r}
# Seasonal plot of a daily period
gg_season(top_stations, number_of_rides, period="day")
```


## Time Series Components
- Our example time-series data has two seasonal periods: daily and weekly
- We can plot the different `components` of our decomposed series via the `autoplot` function

```{r plot-components, echo=FALSE}
# Plotting different components of our TS
decomp <- top_stations %>% 
  model(stl = STL(number_of_rides))

components(decomp) %>% autoplot() + 
  labs(x="Start Time",
       y="Number of Rides", 
       title="Citibike Rides in Jersey City: Time-series Components")
```

## Time Series Components

- We can also seasonally-adjust our data easily in the `fabletools` package
```{r seasonal-adjust, echo=FALSE}
# Correct any negative values since number of rides has a min of 0
seasonal_adjust <- components(decomp) %>% mutate(season_adjust = ifelse(season_adjust < 0, 0, season_adjust))

seasonal_adjust %>%
  as_tsibble() %>%
  autoplot(number_of_rides, colour = "gray") +
  geom_line(aes(y=season_adjust), colour = "blue") +
  labs(x="Start Time", y = "Rides",
       title = "Seasonally-adjusted Number of Citibike Rides: Columbus Drive in Jersey City - Fall 2024")
```



## Moving Averages
- Useful for "smoothing" data to reduce seasonal fluctuations


## Decomposition Methods
- Additive: $Y = S + T + C$
- Multiplicative: $Y = S * T * C$
